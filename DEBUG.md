# 调试指南

## 键盘监听不工作的排查

### 1. 检查控制台日志

运行应用后，观察 Xcode 控制台输出：

**应该看到的日志：**
```
活动监控器已启动（鼠标+键盘）
✅ 键盘监听已启动（需要辅助功能权限才能监听全局键盘）
✅ 已获得辅助功能权限
```

**当你打字时应该看到：**
```
🎹 检测到全局键盘事件: keyDown
⏱️ 活动时间已重置（键盘）
```

**当你移动鼠标时应该看到：**
```
🖱️ 检测到鼠标移动，活动时间已重置
```

**当你不活动时应该看到（每5秒）：**
```
⏳ 无活动 5 秒，还剩 5 秒触发移动
⏳ 无活动 10 秒，还剩 0 秒触发移动
⚠️ 检测到 10 秒无活动（鼠标+键盘），执行随机移动
```

### 2. 验证权限设置

**检查辅助功能权限：**
1. 打开"系统设置" > "隐私与安全性" > "辅助功能"
2. 确认 `MouseKeepAlive` 已勾选
3. 如果应用不在列表中，可能是因为开发模式签名变化
4. 尝试手动添加：点击 `+`，找到 Xcode 生成的 app：
   ```
   ~/Library/Developer/Xcode/DerivedData/MouseKeepAlive-*/Build/Products/Debug/MouseKeepAlive.app
   ```

### 3. 常见问题

#### 问题 1：功能键可以检测到，但字母键检测不到

**症状：**
- 按 Command、Shift、Option 等功能键时有日志：`🎹 全局键盘: 修饰键变化`
- 但输入字母 a、b、c 等时没有日志

**可能原因：**
1. **输入法拦截**：某些输入法（如中文输入法）会拦截按键事件
2. **应用安全限制**：某些安全应用会阻止键盘监听
3. **权限不完整**：辅助功能权限可能没有完全生效

**解决方案：**

1. **切换到英文输入法测试**
   - 按 `Control + Space` 切换到 ABC 英文输入法
   - 在任何应用中输入字母
   - 观察是否有 `🎹 全局键盘: 按下字符键 'x'` 日志

2. **完全重启应用**
   - 在 Xcode 中停止运行
   - 等待 2-3 秒
   - 重新运行应用

3. **重新授予权限**
   - 在"辅助功能"中取消勾选 MouseKeepAlive
   - 完全退出应用
   - 重新运行应用
   - 重新勾选权限
   - **重要**：授权后必须重启应用

4. **检查是否有安全软件干扰**
   - 某些杀毒软件或安全工具会阻止键盘监听
   - 暂时关闭试试

#### 问题 2：没有看到任何键盘事件日志

**可能原因：**
- 辅助功能权限未正确授予
- 需要重启应用使权限生效

**解决方案：**
1. 完全退出应用（Command + Q）
2. 在系统设置中确认权限已勾选
3. 重新运行应用
4. 在 Xcode 控制台中观察日志

#### 问题 2：只能监听本应用的键盘事件

**症状：**
- 在其他应用中打字不会触发键盘事件
- 只有在某些窗口中打字才有效

**原因：**
- `NSEvent.addGlobalMonitorForEvents` 需要辅助功能权限才能监听其他应用的键盘事件
- 没有权限时只能监听本应用内的事件

**解决方案：**
确保在系统设置中授予了辅助功能权限

#### 问题 3：键盘监听返回 nil

**症状：**
```
⚠️ 键盘监听启动失败，可能需要辅助功能权限
```

**原因：**
- `addGlobalMonitorForEvents` 在没有权限时会返回 nil
- 系统阻止了全局事件监听

**解决方案：**
1. 授予辅助功能权限
2. 重启应用

### 4. 手动测试流程

1. **启动应用并观察日志**
   ```
   # 应该看到启动日志
   活动监控器已启动（鼠标+键盘）
   ✅ 键盘监听已启动
   ```

2. **在终端或其他应用中打字**
   ```
   # 每次按键应该触发
   🎹 检测到全局键盘事件: keyDown
   ⏱️ 活动时间已重置（键盘）
   ```

3. **停止打字并等待**
   ```
   # 每5秒应该看到倒计时
   ⏳ 无活动 5 秒，还剩 5 秒触发移动
   ⏳ 无活动 10 秒，还剩 0 秒触发移动
   ⚠️ 检测到 10 秒无活动，执行随机移动
   鼠标已移动到: (x, y)
   ```

4. **恢复打字**
   ```
   # 应该立即重置计时器
   🎹 检测到全局键盘事件: keyDown
   ⏱️ 活动时间已重置（键盘）
   ```

### 5. 如果问题依然存在

1. **清理权限缓存**
   ```bash
   # 重置权限提示标记
   defaults delete com.mousekeepalive.app hasShownPermissionPrompt

   # 重启应用
   ```

2. **检查系统日志**
   ```bash
   # 查看系统安全日志
   log show --predicate 'subsystem == "com.apple.TCC"' --last 5m
   ```

3. **完全重新授权**
   - 在"辅助功能"中取消勾选 MouseKeepAlive
   - 完全退出应用
   - 重新运行应用
   - 在系统设置中重新勾选权限
   - 重启应用

### 6. 开发模式特殊说明

在 Xcode 开发模式下：
- 每次编译应用签名会改变
- macOS 可能将其视为"新应用"
- 可能需要在系统设置中看到多个 MouseKeepAlive 条目
- 建议：只勾选最新的那个（时间戳最新）

## 关闭调试日志

如果调试完成，想关闭详细日志，可以注释掉 `MouseMonitor.swift` 中的 `print` 语句。

保留重要的日志：
- ✅ 已获得辅助功能权限
- ⚠️ 检测到 X 秒无活动，执行随机移动
- 鼠标已移动到: (x, y)

可以删除的调试日志：
- 🎹 检测到全局键盘事件
- 🖱️ 检测到鼠标移动
- ⏱️ 活动时间已重置
- ⏳ 无活动 X 秒
