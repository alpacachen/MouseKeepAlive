name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Build app
      run: |
        xcodebuild \
          -project MouseKeepAlive.xcodeproj \
          -scheme MouseKeepAlive \
          -configuration Release \
          -derivedDataPath build \
          build

    - name: Package app
      run: |
        mkdir -p release
        cp -R build/Build/Products/Release/MouseKeepAlive.app release/
        cd release
        zip -r MouseKeepAlive.app.zip MouseKeepAlive.app
        shasum -a 256 MouseKeepAlive.app.zip > MouseKeepAlive.app.zip.sha256

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/MouseKeepAlive.app.zip
          release/MouseKeepAlive.app.zip.sha256
        body: |
          ## 下载

          下载 `MouseKeepAlive.app.zip`，解压后拖入「应用程序」文件夹即可使用。

          ## 校验

          SHA256: 见 `MouseKeepAlive.app.zip.sha256` 文件

          ## 系统要求

          - macOS 13.0 或更高版本

          ## 更新内容

          请查看下方的 changelog
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
